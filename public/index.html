<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sepolia ‚Üí BSC Cross-Chain Messaging</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.4/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            font-weight: 600;
            color: #495057;
        }

        .status-value {
            color: #007bff;
            font-family: monospace;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }

        .log-error {
            color: #ff6b6b;
            border-left-color: #ff6b6b;
        }

        .log-success {
            color: #51cf66;
            border-left-color: #51cf66;
        }

        .log-info {
            color: #74c0fc;
            border-left-color: #74c0fc;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .status-indicator {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }

        .status-indicator.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-indicator.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-indicator.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            display: block;
            margin: 10px 0;
            color: #495057;
        }

        h3 {
            color: #495057;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        ul li {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .message-list {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            max-height: 200px;
            overflow-y: auto;
        }

        .message-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            background: white;
            border-left: 4px solid #007bff;
            font-size: 0.9rem;
        }

        .message-item.pending {
            border-left-color: #ffc107;
        }

        .message-item.success {
            border-left-color: #28a745;
        }

        .message-item.failed {
            border-left-color: #dc3545;
        }

        .chain-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 0 5px;
        }

        .chain-ethereum {
            background: #627eea;
            color: white;
        }

        .chain-polygon {
            background: #8247e5;
            color: white;
        }

        .chain-bsc {
            background: #f3ba2f;
            color: black;
        }

        .chain-arbitrum {
            background: #28a0f0;
            color: white;
        }

        /* Tabs Styling */
        .tabs {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            background: #f8f9fa;
            color: #495057;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* State Display */
        .state-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e0e0e0;
        }

        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .state-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .state-item label {
            display: block;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .state-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåâ Sepolia ‚Üí BSC Cross-Chain Messaging</h1>
            <p>Live cross-chain message relay between Sepolia Testnet and BSC Testnet</p>
        </div>

        <div class="main-content">
            <div class="section" style="text-align: center;">
                <h2>üöÄ Quick Setup</h2>
                <div class="grid" style="gap: 40px; max-width: 600px; margin: 0 auto;">
                    <div>
                        <h3>Add Networks</h3>
                        <button class="btn btn-secondary" onclick="addSepoliaNetwork()">Add Sepolia</button>
                        <button class="btn btn-secondary" onclick="addBSCTestnetNetwork()">Add BSC</button>
                    </div>
                    
                    <div>
                        <h3>Get Test ETH</h3>
                        <a href="https://sepoliafaucet.com/" target="_blank" class="btn">Sepolia Faucet</a>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <span class="status-label">üëõ Wallet:</span>
                    <span class="status-value" id="walletStatus">Not Connected</span>
                </div>
                <div class="status-item">
                    <span class="status-label">üåê Network:</span>
                    <span class="status-value" id="networkStatus">Connect Wallet</span>
                </div>
                <div class="status-item">
                    <span class="status-label">üîÑ Relayer:</span>
                    <span class="status-value" style="color: #28a745;">Active</span>
                </div>
            </div>

            <div class="section" style="text-align: center; padding: 20px;">
                <h2>üåâ Connect Wallet to Start</h2>
                <p>Connect your wallet to send cross-chain messages</p>
                <button class="btn" onclick="connectWallet()" style="font-size: 1.2rem; padding: 15px 30px;">Connect Wallet</button>
            </div>

            <div class="section">
                <h2>üì® Cross-Chain Message Hub</h2>
                
                <div class="alert alert-info">
                    <strong>üåâ Live Cross-Chain Messaging:</strong> Send real messages from Sepolia Testnet to BSC Testnet. Our relayer automatically processes and delivers messages between chains.
                </div>
                
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label>Source Chain:</label>
                            <div style="padding: 12px; background: #e3f2fd; border-radius: 8px; border: 2px solid #2196f3;">
                                üß™ <strong>Sepolia Testnet</strong> (Chain ID: 11155111)
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Target Chain:</label>
                            <div style="padding: 12px; background: #fff8e1; border-radius: 8px; border: 2px solid #ff9800;">
                                üü° <strong>BSC Testnet</strong> (Chain ID: 97)
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="messageType">Action:</label>
                            <select id="messageType" onchange="updateMessageForm()" style="font-size: 1.1rem;">
                                <option value="setCounter">üìù Set Counter Value</option>
                                <option value="incrementCounter">‚ûï Increment Counter</option>
                                <option value="storeValue">üíæ Store Data</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group" id="valueInput">
                            <label for="messageValue">Value:</label>
                            <input type="number" id="messageValue" placeholder="Enter value" style="font-size: 1.1rem; padding: 15px;" />
                        </div>
                        
                        <div class="form-group">
                            <label>Bridge Fee:</label>
                            <div style="padding: 12px; background: #e8f5e8; border-radius: 8px; color: #2d5d31; font-weight: bold;">
                                ‚úÖ FREE (Testnet)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="sendCrossChainMessage()" style="font-size: 1.2rem; padding: 15px 40px;">üöÄ Send Message</button>
                </div>
            </div>

            <div class="section">
                <h2>üìä Contract State</h2>
                
                <div class="tabs">
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('sepolia')">üß™ Sepolia Testnet</button>
                        <button class="tab-button" onclick="showTab('bsc')">üü° BSC Testnet</button>
                    </div>
                    
                    <div id="sepolia-tab" class="tab-content active">
                        <div class="state-card">
                            <h3>üì§ Source Chain State</h3>
                            <div class="state-grid">
                                <div class="state-item">
                                    <label>Counter Value:</label>
                                    <div class="state-value" id="sepoliaCounter">-</div>
                                </div>
                                <div class="state-item">
                                    <label>Stored Value:</label>
                                    <div class="state-value" id="sepoliaStored">-</div>
                                </div>
                                <div class="state-item">
                                    <label>Messages Sent:</label>
                                    <div class="state-value" id="sepoliaSent">0</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshSepoliaState()">üîÑ Refresh Sepolia</button>
                        </div>
                    </div>
                    
                    <div id="bsc-tab" class="tab-content">
                        <div class="state-card">
                            <h3>üì• Target Chain State</h3>
                            <div class="state-grid">
                                <div class="state-item">
                                    <label>Counter Value:</label>
                                    <div class="state-value" id="bscCounter">-</div>
                                </div>
                                <div class="state-item">
                                    <label>Stored Value:</label>
                                    <div class="state-value" id="bscStored">-</div>
                                </div>
                                <div class="state-item">
                                    <label>Messages Received:</label>
                                    <div class="state-value" id="bscReceived">0</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshBSCState()">üîÑ Refresh BSC</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üîÑ Recent Messages</h2>
                
                <div class="grid">
                    <div>
                        <h3>üì§ Outgoing</h3>
                        <div id="outgoingMessages" class="message-list">
                            <div class="message-item">No messages sent yet</div>
                        </div>
                    </div>
                    
                    <div>
                        <h3>üì• Processed</h3>
                        <div id="incomingMessages" class="message-list">
                            <div class="message-item">Waiting for messages...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üìã Activity Log</h2>
                <button class="btn btn-secondary" onclick="clearLog()">Clear Log</button>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">Welcome to Cross-Chain Messaging Interface</div>
                    <div class="log-entry log-info">Connect your wallet and load contracts to get started</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let web3;
        let account;
        let messengerContract;
        let senderContract;
        let testTargetContract;

        const MESSENGER_ABI = [
            {
                "inputs": [],
                "name": "addRelayer",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address","name": "relayer","type": "address"}],
                "name": "addRelayer",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "chainId","type": "uint256"}],
                "name": "enableChain",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "chainId","type": "uint256"}],
                "name": "disableChain",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address","name": "relayer","type": "address"}],
                "name": "removeRelayer",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256","name": "targetChain","type": "uint256"},
                    {"internalType": "address","name": "targetContract","type": "address"},
                    {"internalType": "bytes","name": "payload","type": "bytes"},
                    {"internalType": "uint256","name": "gasLimit","type": "uint256"}
                ],
                "name": "sendMessage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "bytes32","name": "messageId","type": "bytes32"},
                    {"internalType": "uint256","name": "sourceChain","type": "uint256"},
                    {"internalType": "address","name": "sender","type": "address"},
                    {"internalType": "address","name": "targetContract","type": "address"},
                    {"internalType": "bytes","name": "payload","type": "bytes"},
                    {"internalType": "uint256","name": "nonce","type": "uint256"},
                    {"internalType": "uint256","name": "gasLimit","type": "uint256"},
                    {"internalType": "uint256","name": "expiry","type": "uint256"},
                    {"internalType": "bytes","name": "signature","type": "bytes"}
                ],
                "name": "processMessage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "chainId","type": "uint256"}],
                "name": "getNextNonce",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "bytes32","name": "messageId","type": "bytes32"},
                    {"indexed": true,"internalType": "uint256","name": "targetChain","type": "uint256"},
                    {"indexed": true,"internalType": "address","name": "sender","type": "address"},
                    {"indexed": false,"internalType": "address","name": "targetContract","type": "address"},
                    {"indexed": false,"internalType": "bytes","name": "payload","type": "bytes"},
                    {"indexed": false,"internalType": "uint256","name": "nonce","type": "uint256"},
                    {"indexed": false,"internalType": "uint256","name": "gasLimit","type": "uint256"}
                ],
                "name": "MessageSent",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true,"internalType": "bytes32","name": "messageId","type": "bytes32"},
                    {"indexed": true,"internalType": "uint256","name": "sourceChain","type": "uint256"},
                    {"indexed": true,"internalType": "address","name": "sender","type": "address"},
                    {"indexed": false,"internalType": "address","name": "targetContract","type": "address"},
                    {"indexed": false,"internalType": "bool","name": "success","type": "bool"}
                ],
                "name": "MessageProcessed",
                "type": "event"
            }
        ];

        const SENDER_ABI = [
            {
                "inputs": [
                    {"internalType": "uint256", "name": "targetChainId", "type": "uint256"},
                    {"internalType": "address", "name": "target", "type": "address"},
                    {"internalType": "bytes", "name": "payload", "type": "bytes"}
                ],
                "name": "sendMessage",
                "outputs": [{"internalType": "uint256", "name": "messageId", "type": "uint256"}],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "chainId", "type": "uint256"}],
                "name": "enableChain",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "chainId", "type": "uint256"}],
                "name": "disableChain",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "name": "enabledChains",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "internalType": "uint256", "name": "messageId", "type": "uint256"},
                    {"indexed": true, "internalType": "uint256", "name": "targetChainId", "type": "uint256"},
                    {"indexed": true, "internalType": "address", "name": "sender", "type": "address"},
                    {"indexed": false, "internalType": "address", "name": "target", "type": "address"},
                    {"indexed": false, "internalType": "bytes", "name": "payload", "type": "bytes"},
                    {"indexed": false, "internalType": "uint256", "name": "nonce", "type": "uint256"},
                    {"indexed": false, "internalType": "uint256", "name": "timestamp", "type": "uint256"}
                ],
                "name": "MessageSent",
                "type": "event"
            }
        ];

        const TEST_TARGET_ABI = [
            {
                "inputs": [{"internalType": "uint256","name": "_counter","type": "uint256"}],
                "name": "setCounter",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "incrementCounter",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256","name": "_value","type": "uint256"}],
                "name": "storeValue",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "counter",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "storedValue",
                "outputs": [{"internalType": "uint256","name": "","type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Contract Addresses
        const SEPOLIA_ADDRESSES = {
            crossChainMessageSender: '0x7E998120D1A91BA1488FCac0e7B5f055827b5873',
            crossChainMessenger: '0x4101eF79E648226F2717228C54846bD5c7DF1B0d',
            testTarget: '0xD8a4ef6f66235338bA19b12e1034fdC20fD9d6dC'
        };

        const BSC_ADDRESSES = {
            crossChainMessageSender: '0x5a5a2d0b7899A5Bef0506B10F001685B28E7F8c9',
            crossChainMessenger: '0x86304b56857fB2DC816719557b8F62DDb716A74D',
            testTarget: '0x86304b56857fB2DC816719557b8F62DDb716A74D'
        };

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    web3 = new Web3(window.ethereum);
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    
                    const networkId = await web3.eth.net.getId();
                    
                    document.getElementById('walletStatus').textContent = `${account.substring(0, 6)}...${account.substring(38)}`;
                    document.getElementById('walletStatus').style.color = '#28a745';
                    
                    // Auto-detect network and load contracts
                    if (networkId == 11155111) {
                        document.getElementById('networkStatus').textContent = 'Sepolia Testnet';
                        document.getElementById('networkStatus').style.color = '#28a745';
                        await autoLoadContracts('sepolia');
                    } else if (networkId == 97) {
                        document.getElementById('networkStatus').textContent = 'BSC Testnet';
                        document.getElementById('networkStatus').style.color = '#28a745';
                        await autoLoadContracts('bsc');
                    } else {
                        document.getElementById('networkStatus').textContent = `Unsupported (${networkId})`;
                        document.getElementById('networkStatus').style.color = '#dc3545';
                        logMessage('Please switch to Sepolia Testnet to send messages', 'error');
                        return;
                    }
                    
                    logMessage('Wallet connected successfully', 'success');
                } else {
                    logMessage('MetaMask not detected. Please install MetaMask.', 'error');
                }
            } catch (error) {
                logMessage(`Error connecting wallet: ${error.message}`, 'error');
            }
        }

        async function autoLoadContracts(network) {
            try {
                let addresses;
                
                if (network === 'sepolia') {
                    addresses = SEPOLIA_ADDRESSES;
                    logMessage('Loading Sepolia contracts...', 'info');
                } else if (network === 'bsc') {
                    addresses = BSC_ADDRESSES;
                    logMessage('Loading BSC contracts...', 'info');
                } else {
                    logMessage('Unsupported network', 'error');
                    return;
                }
                
                messengerContract = new web3.eth.Contract(MESSENGER_ABI, addresses.crossChainMessenger);
                senderContract = new web3.eth.Contract(SENDER_ABI, addresses.crossChainMessageSender);
                testTargetContract = new web3.eth.Contract(TEST_TARGET_ABI, addresses.testTarget);
                
                logMessage('‚úÖ Contracts loaded automatically', 'success');
                
                // Auto-refresh states for both chains
                setTimeout(async () => {
                    await autoRefreshStates();
                }, 1000);
                
            } catch (error) {
                logMessage(`Error loading contracts: ${error.message}`, 'error');
            }
        }

        async function refreshState() {
            try {
                if (!testTargetContract) {
                    logMessage('Please load contracts first', 'error');
                    return;
                }
                
                // Check if contract is deployed at the address
                const code = await web3.eth.getCode(testTargetContract.options.address);
                if (code === '0x') {
                    logMessage('TestTarget contract not deployed at the specified address', 'error');
                    return;
                }
                
                logMessage('Calling counter() method...', 'info');
                const counter = await testTargetContract.methods.counter().call();
                logMessage(`Counter value: ${counter}`, 'info');
                
                logMessage('Calling storedValue() method...', 'info');
                const storedValue = await testTargetContract.methods.storedValue().call();
                logMessage(`Stored value: ${storedValue}`, 'info');
                
                document.getElementById('counterValue').value = counter;
                document.getElementById('storedValue').value = storedValue;
                
                logMessage('Contract state refreshed successfully', 'success');
            } catch (error) {
                logMessage(`Error refreshing state: ${error.message}`, 'error');
                logMessage(`Contract address: ${testTargetContract?.options?.address}`, 'error');
                logMessage('Please check if the TestTarget contract is deployed correctly', 'error');
            }
        }

        function updateMessageForm() {
            const messageType = document.getElementById('messageType').value;
            const valueInput = document.getElementById('valueInput');
            
            if (messageType === 'incrementCounter') {
                valueInput.style.display = 'none';
            } else {
                valueInput.style.display = 'block';
            }
        }
        
        // Global message tracking
        let messageCounter = 0;
        let pendingMessages = [];

        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            logMessage('Log cleared', 'info');
        }

        // Initialize form
        updateMessageForm();
        
        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('sepolia-tab').classList.remove('active');
            document.getElementById('bsc-tab').classList.remove('active');
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active to clicked button
            event.target.classList.add('active');
        }
        
        // State refresh functions
        async function refreshSepoliaState() {
            try {
                logMessage('üîÑ Refreshing Sepolia state...', 'info');
                
                // Create Web3 instance for Sepolia
                const sepoliaWeb3 = new Web3('https://ethereum-sepolia-rpc.publicnode.com');
                const sepoliaContract = new sepoliaWeb3.eth.Contract(TEST_TARGET_ABI, SEPOLIA_ADDRESSES.testTarget);
                
                // Get counter and stored values
                const counter = await sepoliaContract.methods.counter().call();
                const storedValue = await sepoliaContract.methods.storedValue().call();
                
                // Update display
                document.getElementById('sepoliaCounter').textContent = counter;
                document.getElementById('sepoliaStored').textContent = storedValue;
                
                logMessage('‚úÖ Sepolia state refreshed', 'success');
            } catch (error) {
                logMessage(`‚ùå Error refreshing Sepolia state: ${error.message}`, 'error');
                document.getElementById('sepoliaCounter').textContent = 'Error';
                document.getElementById('sepoliaStored').textContent = 'Error';
            }
        }
        
        async function refreshBSCState() {
            try {
                logMessage('üîÑ Refreshing BSC state...', 'info');
                
                // Create Web3 instance for BSC
                const bscWeb3 = new Web3('https://data-seed-prebsc-1-s1.binance.org:8545');
                const bscContract = new bscWeb3.eth.Contract(TEST_TARGET_ABI, BSC_ADDRESSES.testTarget);
                
                // Get counter and stored values
                const counter = await bscContract.methods.counter().call();
                const storedValue = await bscContract.methods.storedValue().call();
                
                // Update display
                document.getElementById('bscCounter').textContent = counter;
                document.getElementById('bscStored').textContent = storedValue;
                
                logMessage('‚úÖ BSC state refreshed', 'success');
            } catch (error) {
                logMessage(`‚ùå Error refreshing BSC state: ${error.message}`, 'error');
                document.getElementById('bscCounter').textContent = 'Error';
                document.getElementById('bscStored').textContent = 'Error';
            }
        }
        
        // Auto-refresh state when wallet connects
        async function autoRefreshStates() {
            await refreshSepoliaState();
            await refreshBSCState();
        }

        async function sendCrossChainMessage() {
            try {
                if (!senderContract || !account) {
                    logMessage('Please connect wallet and load contracts first', 'error');
                    return;
                }
                
                // Fixed: Sepolia ‚Üí BSC Testnet
                const sourceChain = '11155111'; // Sepolia
                const targetChain = '97';       // BSC Testnet
                const messageType = document.getElementById('messageType').value;
                const messageValue = document.getElementById('messageValue').value;
                
                if (!messageValue && messageType !== 'incrementCounter') {
                    logMessage('Please enter a value for the message', 'error');
                    return;
                }
                
                // Use BSC TestTarget address
                const targetContractAddress = BSC_ADDRESSES.testTarget;
                
                // Encode the payload based on message type
                let payload;
                if (messageType === 'setCounter') {
                    // Encode setCounter(uint256) call
                    payload = web3.eth.abi.encodeFunctionCall({
                        name: 'setCounter',
                        type: 'function',
                        inputs: [{type: 'uint256', name: 'newCounter'}]
                    }, [messageValue]);
                } else if (messageType === 'incrementCounter') {
                    // Encode incrementCounter() call
                    payload = web3.eth.abi.encodeFunctionCall({
                        name: 'incrementCounter',
                        type: 'function',
                        inputs: []
                    }, []);
                } else if (messageType === 'storeValue') {
                    // Encode storeValue(uint256) call
                    payload = web3.eth.abi.encodeFunctionCall({
                        name: 'storeValue',
                        type: 'function',
                        inputs: [{type: 'uint256', name: 'value'}]
                    }, [messageValue]);
                }
                
                logMessage(`üöÄ Sending cross-chain message: Sepolia ‚Üí BSC Testnet`, 'info');
                logMessage(`üìã Target Contract: ${targetContractAddress}`, 'info');
                logMessage(`üìã Message Type: ${messageType}, Value: ${messageValue || 'N/A'}`, 'info');
                
                // Call the CrossChainMessageSender contract
                const tx = await senderContract.methods.sendMessage(
                    targetChain,
                    targetContractAddress,
                    payload
                ).send({
                    from: account,
                    gas: 300000  // Gas for the sendMessage transaction
                });
                
                logMessage(`‚úÖ Cross-chain message sent! Tx: ${tx.transactionHash}`, 'success');
                logMessage(`üîó View on Sepolia: https://sepolia.etherscan.io/tx/${tx.transactionHash}`, 'info');
                logMessage(`‚è≥ Relayer will process this message and deliver to BSC Testnet`, 'info');
                
                const messageId = ++messageCounter;
                const message = {
                    id: messageId,
                    sourceChain: 'Sepolia Testnet',
                    targetChain: 'BSC Testnet',
                    type: messageType,
                    value: messageValue || 'N/A',
                    status: 'pending',
                    timestamp: new Date().toLocaleTimeString(),
                    txHash: tx.transactionHash
                };
                
                addOutgoingMessage(message);
                
            } catch (error) {
                logMessage(`‚ùå Error sending cross-chain message: ${error.message}`, 'error');
                console.error('Cross-chain error details:', error);
            }
        }
        
        function simulateMessageProcessing(message) {
            // Simulate processing delay
            setTimeout(() => {
                message.status = 'relaying';
                updateMessageStatus(message);
                logMessage(`üîÑ Message ${message.id} being processed by relayers...`, 'info');
            }, 2000);
            
            setTimeout(() => {
                message.status = 'success';
                updateMessageStatus(message);
                addIncomingMessage(message);
                logMessage(`‚úÖ Message ${message.id} successfully delivered to ${message.targetChain}!`, 'success');
            }, 5000);
        }
        
        function addOutgoingMessage(message) {
            const container = document.getElementById('outgoingMessages');
            if (container.children[0]?.textContent === 'No messages sent yet') {
                container.innerHTML = '';
            }
            
            const messageElement = createMessageElement(message);
            container.appendChild(messageElement);
        }
        
        function addIncomingMessage(message) {
            const container = document.getElementById('incomingMessages');
            if (container.children[0]?.textContent === 'No messages received yet') {
                container.innerHTML = '';
            }
            
            const messageElement = createMessageElement(message);
            container.appendChild(messageElement);
        }
        
        function createMessageElement(message) {
            const div = document.createElement('div');
            div.className = `message-item ${message.status}`;
            div.id = `message-${message.id}`;
            div.innerHTML = `
                <div><strong>Message #${message.id}</strong> - ${message.type}</div>
                <div>
                    <span class="chain-badge">${message.sourceChain}</span> ‚Üí 
                    <span class="chain-badge">${message.targetChain}</span>
                </div>
                <div>Value: ${message.value} | Status: ${message.status} | ${message.timestamp}</div>
            `;
            return div;
        }
        
        function updateMessageStatus(message) {
            const element = document.getElementById(`message-${message.id}`);
            if (element) {
                element.className = `message-item ${message.status}`;
                element.querySelector('div:last-child').textContent = 
                    `Value: ${message.value} | Status: ${message.status} | ${message.timestamp}`;
            }
        }
        
        function getChainName(chainId) {
            const names = {
                '1': 'Ethereum',
                '137': 'Polygon', 
                '56': 'BSC',
                '97': 'BSC Testnet',
                '42161': 'Arbitrum',
                '31337': 'Hardhat',
                '11155111': 'Sepolia'
            };
            return names[chainId] || `Chain ${chainId}`;
        }
        
        function refreshMessageStatus() {
            logMessage('üîÑ Refreshing message status...', 'info');
            // In a real app, this would query the blockchain for message states
            logMessage('‚úÖ Message status refreshed', 'success');
        }

        async function addSepoliaNetwork() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0xaa36a7', // 11155111 in hex
                            chainName: 'Sepolia Testnet',
                            nativeCurrency: {
                                name: 'Ethereum',
                                symbol: 'ETH',
                                decimals: 18
                            },
                            rpcUrls: ['https://ethereum-sepolia-rpc.publicnode.com'],
                            blockExplorerUrls: ['https://sepolia.etherscan.io']
                        }]
                    });
                    logMessage('‚úÖ Sepolia testnet added to MetaMask!', 'success');
                } else {
                    logMessage('‚ùå MetaMask not detected', 'error');
                }
            } catch (error) {
                logMessage(`Error adding network: ${error.message}`, 'error');
            }
        }

        async function addBSCTestnetNetwork() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x61', // 97 in hex
                            chainName: 'BSC Testnet',
                            nativeCurrency: {
                                name: 'BNB',
                                symbol: 'BNB',
                                decimals: 18
                            },
                            rpcUrls: ['https://data-seed-prebsc-1-s1.binance.org:8545'],
                            blockExplorerUrls: ['https://testnet.bscscan.com']
                        }]
                    });
                    logMessage('‚úÖ BSC testnet added to MetaMask!', 'success');
                } else {
                    logMessage('‚ùå MetaMask not detected', 'error');
                }
            } catch (error) {
                logMessage(`Error adding network: ${error.message}`, 'error');
            }
        }

        async function copyTestAccount() {
            const privateKey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
            const indicator = document.getElementById('accountCopyIndicator');
            
            try {
                await navigator.clipboard.writeText(privateKey);
                indicator.className = 'status-indicator success';
                indicator.textContent = '‚úÖ Private key copied to clipboard!';
                logMessage('Test account private key copied to clipboard', 'success');
                
                setTimeout(() => {
                    indicator.textContent = '';
                    indicator.className = '';
                }, 3000);
            } catch (error) {
                indicator.className = 'status-indicator error';
                indicator.textContent = '‚ùå Failed to copy. Copy manually from above.';
            }
        }
    </script>
</body>
</html> 
</html> 